<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能问卷填写系统 - 三阶段智能核心版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mode-card {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .mode-card h3 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .mode-card .features {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .mode-card .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .advanced-options {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .advanced-options h4 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .status-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .status-item .label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }

        .status-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-item.online .value {
            color: #27ae60;
        }

        .status-item.offline .value {
            color: #e74c3c;
        }

        .task-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e1e8ed;
        }

        .task-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .task-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-status.running {
            background: #3498db;
            color: white;
        }

        .task-status.completed {
            background: #27ae60;
            color: white;
        }

        .task-status.failed {
            background: #e74c3c;
            color: white;
        }

        .task-status.created {
            background: #f39c12;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .phase-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 5px;
        }

        .phase-step.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .phase-step.completed {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }

        .phase-step .icon {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        .results-section {
            margin-top: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-card h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .result-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e1e8ed;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }

        /* 经验分析专用样式 */
        .experience-section {
            margin-top: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
        }

        .experience-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .experience-card h5 {
            margin-bottom: 0.8rem;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.5rem;
        }

        .scout-experiences {
            max-height: 300px;
            overflow-y: auto;
        }

        .scout-experience-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .scout-experience-item .scout-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.3rem;
        }

        .scout-experience-item .experience-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .analysis-item strong {
            min-width: 120px;
            color: #2c3e50;
            margin-right: 0.5rem;
        }

        .analysis-item span {
            color: #495057;
        }

        .trap-questions {
            max-height: 150px;
            overflow-y: auto;
        }

        .trap-question-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .success-patterns {
            max-height: 150px;
            overflow-y: auto;
        }

        .success-pattern-item {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .guidance-rules {
            max-height: 200px;
            overflow-y: auto;
        }

        .guidance-rule-item {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .guidance-rule-item .rule-pattern {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 0.3rem;
        }

        .guidance-rule-item .rule-answer {
            color: #388e3c;
            margin-bottom: 0.3rem;
        }

        .guidance-rule-item .rule-confidence {
            font-size: 0.8rem;
            color: #757575;
        }

        .confidence-score {
            font-weight: bold;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            color: white;
        }

        .confidence-score.high { background: #4caf50; }
        .confidence-score.medium { background: #ff9800; }
        .confidence-score.low { background: #f44336; }

        .target-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .target-result-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .target-result-item.failed {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
        }

        .target-result-item .target-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .target-result-item .result-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .mode-selection {
                grid-template-columns: 1fr;
            }
            
            .param-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }

            .experience-section {
                padding: 1rem;
            }

            .experience-card {
                padding: 0.8rem;
            }
        }

        /* 🆕 新增：加载动画样式 */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Gemini分析区域样式 */
        #gemini-analysis-section {
            border: 2px solid #667eea !important;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%) !important;
        }
        
        .analysis-item {
            margin-bottom: 0.8rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .analysis-item:last-child {
            border-bottom: none;
        }
        
        .confidence-score {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .confidence-score.high {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-score.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .confidence-score.low {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧠 智能问卷填写系统</h1>
        <p class="subtitle">三阶段智能核心版 - 敢死队情报收集 → Gemini分析 → 大部队指导作战</p>
    </div>

    <div class="container">
        <!-- 系统状态面板 -->
        <div class="card">
            <h2>📊 系统状态</h2>
            <div class="status-panel">
                <div class="status-grid" id="systemStatus">
                    <div class="status-item">
                        <div class="label">三阶段智能系统</div>
                        <div class="value" id="threeStageStatus">检查中...</div>
                    </div>
                    <div class="status-item">
                        <div class="label">传统系统</div>
                        <div class="value" id="enhancedStatus">检查中...</div>
                    </div>
                    <div class="status-item">
                        <div class="label">知识库API</div>
                        <div class="value" id="knowledgeStatus">检查中...</div>
                    </div>
                    <div class="status-item">
                        <div class="label">活跃任务</div>
                        <div class="value" id="activeTaskCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 任务创建面板 -->
        <div class="card">
            <h2>🚀 创建新任务</h2>
            
            <!-- 模式选择 -->
            <div class="form-group">
                <label>选择执行模式</label>
                <div class="mode-selection">
                    <div class="mode-card active" data-mode="three_stage">
                        <div class="badge">推荐</div>
                        <h3>🧠 三阶段智能模式</h3>
                        <div class="features">
                            敢死队情报收集<br>
                            Gemini智能分析<br>
                            大部队指导作战<br>
                            高成功率保证
                        </div>
                    </div>
                    <div class="mode-card" data-mode="traditional">
                        <h3>⚡ 传统模拟模式</h3>
                        <div class="features">
                            快速模拟执行<br>
                            基础数据分析<br>
                            兼容性测试<br>
                            演示功能
                        </div>
                    </div>
                </div>
            </div>

            <!-- 基础参数 -->
            <div class="form-group">
                <label for="questionnaireUrl">问卷URL</label>
                <input type="url" id="questionnaireUrl" placeholder="请输入问卷链接，例如: https://www.wjx.cn/vm/example.aspx" required>
            </div>

            <!-- 高级选项 -->
            <div class="advanced-options">
                <h4>⚙️ 高级参数</h4>
                <div class="param-grid">
                    <div class="form-group">
                        <label for="scoutCount">敢死队数量</label>
                        <select id="scoutCount">
                            <option value="1" selected>1人（测试模式）</option>
                            <option value="2">2人（快速模式）</option>
                            <option value="3">3人（推荐）</option>
                            <option value="5">5人（深度探索）</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="targetCount">大部队数量</label>
                        <select id="targetCount">
                            <option value="2" selected>2人（测试模式）</option>
                            <option value="5">5人（快速）</option>
                            <option value="10">10人（标准）</option>
                            <option value="20">20人（扩展）</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="createTask()" id="createBtn">
                🚀 启动智能问卷任务
            </button>
        </div>

        <!-- 活跃任务显示 -->
        <div id="activeTasksContainer" class="hidden">
            <div class="card">
                <h2>📋 当前任务</h2>
                <div id="activeTasksList"></div>
            </div>
        </div>

        <!-- 任务历史显示 -->
        <div id="taskHistoryContainer" class="hidden">
            <div class="card">
                <h2>📈 任务历史</h2>
                <div id="taskHistoryList"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = 'three_stage';
        let currentTask = null;
        let refreshInterval = null;

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            checkSystemStatus();
            
            // 设置定时刷新
            setInterval(checkSystemStatus, 30000); // 每30秒检查一次系统状态
        });

        // 初始化系统
        function initializeSystem() {
            // 模式选择事件
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectMode(this.dataset.mode);
                });
            });
        }

        // 选择模式
        function selectMode(mode) {
            selectedMode = mode;
            
            // 更新UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // 更新按钮文本
            const btn = document.getElementById('createBtn');
            if (mode === 'three_stage') {
                btn.textContent = '🧠 启动三阶段智能任务';
            } else {
                btn.textContent = '⚡ 启动传统模拟任务';
            }
        }

        // 检查系统状态
        async function checkSystemStatus() {
            try {
                const response = await fetch('/system_status');
                const data = await response.json();
                
                updateStatusDisplay('threeStageStatus', data.three_stage_system_available, '已启用', '未启用');
                updateStatusDisplay('enhancedStatus', data.enhanced_system_available, '已启用', '未启用');
                updateStatusDisplay('knowledgeStatus', data.knowledge_api_available, '在线', '离线');
                
                document.getElementById('activeTaskCount').textContent = data.active_tasks_count;
                
            } catch (error) {
                console.error('检查系统状态失败:', error);
                updateStatusDisplay('threeStageStatus', false, '已启用', '连接失败');
                updateStatusDisplay('enhancedStatus', false, '已启用', '连接失败');
                updateStatusDisplay('knowledgeStatus', false, '在线', '连接失败');
            }
        }

        // 更新状态显示
        function updateStatusDisplay(elementId, isOnline, onlineText, offlineText) {
            const element = document.getElementById(elementId);
            element.textContent = isOnline ? onlineText : offlineText;
            element.parentElement.className = `status-item ${isOnline ? 'online' : 'offline'}`;
        }

        // 创建任务
        async function createTask() {
            const url = document.getElementById('questionnaireUrl').value.trim();
            const scoutCount = parseInt(document.getElementById('scoutCount').value);
            const targetCount = parseInt(document.getElementById('targetCount').value);
            
            // 验证输入
            if (!url) {
                alert('请输入问卷URL');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('请输入有效的URL地址（必须以http://或https://开头）');
                return;
            }
            
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = '🚀 正在创建任务...';
            
            try {
                const response = await fetch('/create_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questionnaire_url: url,
                        scout_count: scoutCount,
                        target_count: targetCount,
                        task_mode: selectedMode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTask = data.task_id;
                    alert(`✅ ${data.message}\n任务ID: ${data.task_id}`);
                    
                    // 开始监控任务
                    startTaskMonitoring(data.task_id);
                    
                    // 清空表单
                    document.getElementById('questionnaireUrl').value = '';
                    
                } else {
                    alert(`❌ 创建任务失败: ${data.error}`);
                }
                
            } catch (error) {
                console.error('创建任务失败:', error);
                alert(`❌ 创建任务失败: ${error.message}`);
            } finally {
                createBtn.disabled = false;
                selectMode(selectedMode); // 恢复按钮文本
            }
        }

        // 开始任务监控
        function startTaskMonitoring(taskId) {
            // 停止之前的监控
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // 立即刷新一次
            refreshTask(taskId);
            
            // 设置定时刷新
            refreshInterval = setInterval(() => {
                refreshTask(taskId);
            }, 2000);
        }

        // 刷新任务状态
        function refreshTask(taskId) {
            fetch(`/refresh_task/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTaskDisplay(data.task);
                        
                        // 🆕 新增：如果任务进入第二阶段，获取Gemini分析结果
                        if (data.task.progress && data.task.progress.current_phase >= 2) {
                            fetchGeminiAnalysis(taskId);
                        }
                    }
                })
                .catch(error => {
                    console.error('刷新任务失败:', error);
                });
        }
        
        // 🆕 新增：获取Gemini截图分析结果
        function fetchGeminiAnalysis(taskId) {
            fetch(`/get_gemini_analysis/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.has_analysis) {
                        displayGeminiAnalysis(data.gemini_analysis);
                    } else {
                        displayGeminiAnalysisPlaceholder(data.message || '暂无Gemini分析结果');
                    }
                })
                .catch(error => {
                    console.error('获取Gemini分析失败:', error);
                    displayGeminiAnalysisPlaceholder('获取Gemini分析失败');
                });
        }
        
        // 🆕 新增：显示Gemini分析结果
        function displayGeminiAnalysis(analysisData) {
            const contentDiv = document.getElementById('gemini-analysis-content');
            if (!contentDiv) return;
            
            const guidancePreview = analysisData.guidance_preview || '无指导内容';
            const bestScout = analysisData.best_scout || '未知';
            const analysisTime = analysisData.analysis_time ? new Date(analysisData.analysis_time).toLocaleString() : '未知时间';
            const screenshotPath = analysisData.screenshot_filepath || '';
            
            contentDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: #667eea;">📸 基于最成功敢死队截图的AI分析</span>
                        <span style="font-size: 0.9rem; color: #666;">${analysisTime}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>分析来源：</strong>敢死队 "${bestScout}" 的成功截图
                    </div>
                    <div style="background: #f8f9ff; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea;">
                        <strong>🎯 大部队作答经验指导：</strong><br>
                        <div style="margin-top: 8px; line-height: 1.6; color: #333;">
                            ${guidancePreview}
                        </div>
                    </div>
                    ${screenshotPath ? `
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            📁 处理后截图已保存: ${screenshotPath.split('/').pop()}
                        </div>
                    ` : ''}
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="fetchProcessedScreenshots()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                        查看所有处理后截图
                    </button>
                </div>
            `;
        }
        
        // 🆕 新增：显示Gemini分析占位符
        function displayGeminiAnalysisPlaceholder(message) {
            const contentDiv = document.getElementById('gemini-analysis-content');
            if (!contentDiv) return;
            
            contentDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">🤖</div>
                    <div>${message}</div>
                    <div style="margin-top: 10px; font-size: 0.9rem;">
                        Gemini截图分析将在敢死队完成后自动进行
                    </div>
                </div>
            `;
        }
        
        // 🆕 新增：获取处理后截图列表
        function fetchProcessedScreenshots() {
            fetch('/get_processed_screenshots')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProcessedScreenshots(data.screenshots, data.total_count);
                    } else {
                        alert('获取截图列表失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('获取截图列表失败:', error);
                    alert('获取截图列表失败');
                });
        }
        
        // 🆕 新增：显示处理后截图列表
        function displayProcessedScreenshots(screenshots, totalCount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 10px; padding: 20px; 
                max-width: 80%; max-height: 80%; overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>📸 处理后截图列表 (共${totalCount}张)</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">关闭</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                    ${screenshots.map(screenshot => `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
                                ${screenshot.filename}
                            </div>
                            <div style="font-size: 0.9rem; color: #666; line-height: 1.4;">
                                <div><strong>类型:</strong> ${screenshot.analysis_type}</div>
                                <div><strong>大小:</strong> ${screenshot.size_kb} KB</div>
                                <div><strong>创建时间:</strong> ${new Date(screenshot.created_time).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // 显示任务
        function displayTask(task, isCompleted) {
            const container = document.getElementById('activeTasksContainer');
            const tasksList = document.getElementById('activeTasksList');
            
            container.classList.remove('hidden');
            
            const taskHtml = generateTaskHtml(task, isCompleted);
            tasksList.innerHTML = taskHtml;
        }

        // 生成任务HTML
        function generateTaskHtml(task, isCompleted) {
            const progress = calculateProgress(task);
            const statusClass = getStatusClass(task.status);
            
            let phaseDetailsHtml = '';
            if (task.task_mode === 'three_stage') {
                phaseDetailsHtml = generateThreeStagePhaseDetails(task);
            } else {
                phaseDetailsHtml = generateTraditionalPhaseDetails(task);
            }
            
            let resultsHtml = '';
            if (isCompleted && task.results) {
                resultsHtml = generateResultsHtml(task.results, task.task_mode);
            }
            
            return `
                <div class="task-panel">
                    <div class="task-header">
                        <div>
                            <div class="task-id">任务ID: ${task.task_id}</div>
                            <div class="mt-2">
                                <strong>模式:</strong> ${task.task_mode === 'three_stage' ? '🧠 三阶段智能模式' : '⚡ 传统模拟模式'}
                            </div>
                            <div><strong>问卷:</strong> ${task.questionnaire_url}</div>
                            <div><strong>敢死队:</strong> ${task.scout_count}人 | <strong>大部队:</strong> ${task.target_count}人</div>
                        </div>
                        <div class="task-status ${statusClass}">
                            ${task.status}
                        </div>
                    </div>
                    
                    <div><strong>当前阶段:</strong> ${task.phase}</div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="text-center" style="font-size: 0.9rem; color: #7f8c8d;">
                        进度: ${progress}% (第${task.progress.current_phase}阶段/共${task.progress.total_phases}阶段)
                    </div>
                    
                    ${phaseDetailsHtml}
                    
                    ${resultsHtml}
                </div>
            `;
        }

        // 生成三阶段流程详情
        function generateThreeStagePhaseDetails(task) {
            const phases = [
                { key: 'phase1_complete', name: '第一阶段：敢死队情报收集', icon: '🔍' },
                { key: 'phase2_complete', name: '第二阶段：Gemini智能分析', icon: '🧠' },
                { key: 'phase3_complete', name: '第三阶段：大部队招募选择', icon: '👥' },
                { key: 'phase4_complete', name: '第四阶段：智能指导作战', icon: '🎯' }
            ];
            
            return `
                <div class="phase-details">
                    <h4>📋 三阶段智能流程</h4>
                    ${phases.map((phase, index) => {
                        const isActive = task.progress.current_phase === index + 1;
                        const isCompleted = task.progress[phase.key];
                        const stepClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
                        
                        return `
                            <div class="phase-step ${stepClass}">
                                <span class="icon">${phase.icon}</span>
                                <span>${phase.name}</span>
                                ${isCompleted ? '<span style="margin-left: auto;">✅</span>' : ''}
                                ${isActive && !isCompleted ? '<span style="margin-left: auto;">⏳</span>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // 生成传统流程详情
        function generateTraditionalPhaseDetails(task) {
            const phases = [
                { key: 'phase1_complete', name: '阶段1：基础设施准备', icon: '⚙️' },
                { key: 'phase2_complete', name: '阶段2：问卷执行', icon: '📝' }
            ];
            
            return `
                <div class="phase-details">
                    <h4>📋 传统执行流程</h4>
                    ${phases.map((phase, index) => {
                        const isActive = task.progress.current_phase === index + 1;
                        const isCompleted = task.progress[phase.key];
                        const stepClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
                        
                        return `
                            <div class="phase-step ${stepClass}">
                                <span class="icon">${phase.icon}</span>
                                <span>${phase.name}</span>
                                ${isCompleted ? '<span style="margin-left: auto;">✅</span>' : ''}
                                ${isActive && !isCompleted ? '<span style="margin-left: auto;">⏳</span>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // 生成结果HTML
        function generateResultsHtml(results, taskMode) {
            if (taskMode === 'three_stage') {
                return generateThreeStageResults(results);
            } else {
                return generateTraditionalResults(results);
            }
        }

        // 生成三阶段结果
        function generateThreeStageResults(results) {
            const scoutPhase = results.scout_phase || {};
            const analysisPhase = results.analysis_phase || {};
            const targetPhase = results.target_phase || {};
            const overall = results.overall || {};
            
            return `
                <div class="results-section">
                    <h4>📊 三阶段智能执行结果</h4>
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>🔍 敢死队阶段</h4>
                            <div class="result-value">${(scoutPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                成功率 (${scoutPhase.successful_scouts || 0}/${scoutPhase.total_scouts || 0})<br>
                                收集经验: ${scoutPhase.experiences_collected || 0}条
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>🧠 智能分析</h4>
                            <div class="result-value">${(analysisPhase.confidence_score * 100).toFixed(0)}%</div>
                            <div class="result-description">
                                分析可信度<br>
                                生成规则: ${analysisPhase.guidance_rules_generated || 0}条
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>🎯 大部队阶段</h4>
                            <div class="result-value">${(targetPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                成功率 (${targetPhase.successful_targets || 0}/${targetPhase.total_targets || 0})<br>
                                相似成员: ${targetPhase.similar_members || 0}人
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>📈 总体效果</h4>
                            <div class="result-value">${(overall.overall_success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                整体成功率<br>
                                提升: ${(overall.improvement_rate * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    
                    ${generateIntelligenceAnalysisDetails(analysisPhase.intelligence_analysis)}
                    
                    ${generateScoutExperiencesDetails(scoutPhase)}
                    
                    ${generateTargetResultsDetails(targetPhase)}
                </div>
            `;
        }

        // 生成智能分析详情
        function generateIntelligenceAnalysisDetails(intelligence) {
            if (!intelligence) return '';
            
            return `
                <div class="experience-section">
                    <h4>🧠 智能分析详情</h4>
                    
                    <!-- 🆕 新增：Gemini截图分析结果显示 -->
                    <div id="gemini-analysis-section" class="experience-card" style="border: 2px solid #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);">
                        <h5>📸 Gemini截图分析指导</h5>
                        <div id="gemini-analysis-content">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span style="margin-left: 10px;">正在获取Gemini截图分析结果...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 基本分析信息 -->
                    <div class="experience-card">
                        <h5>📊 基础分析</h5>
                        <div class="analysis-item">
                            <strong>问卷主题：</strong>
                            <span>${intelligence.questionnaire_theme || '未知'}</span>
                        </div>
                        <div class="analysis-item">
                            <strong>目标人群：</strong>
                            <span>${formatTargetAudience(intelligence.target_audience)}</span>
                        </div>
                        <div class="analysis-item">
                            <strong>分析可信度：</strong>
                            <span class="confidence-score ${getConfidenceClass(intelligence.confidence_score)}">
                                ${(intelligence.confidence_score * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>

                    <!-- 陷阱题目分析 -->
                    ${intelligence.trap_questions && intelligence.trap_questions.length > 0 ? `
                        <div class="experience-card">
                            <h5>⚠️ 陷阱题目识别</h5>
                            <div class="trap-questions">
                                ${intelligence.trap_questions.map(trap => `
                                    <div class="trap-question-item">
                                        <strong>题目：</strong>${trap.question || '未知题目'}<br>
                                        <strong>陷阱类型：</strong>${trap.trap_type || '未知类型'}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- 成功模式分析 -->
                    ${intelligence.success_patterns && intelligence.success_patterns.length > 0 ? `
                        <div class="experience-card">
                            <h5>✅ 成功模式识别</h5>
                            <div class="success-patterns">
                                ${intelligence.success_patterns.map(pattern => `
                                    <div class="success-pattern-item">
                                        <strong>模式：</strong>${pattern.pattern || '未知模式'}<br>
                                        <strong>成功率：</strong>${(pattern.success_rate * 100).toFixed(1)}%
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- 指导规则 -->
                    ${intelligence.guidance_rules && intelligence.guidance_rules.length > 0 ? `
                        <div class="experience-card">
                            <h5>📋 生成的智能指导规则</h5>
                            <div class="guidance-rules">
                                ${intelligence.guidance_rules.map(rule => `
                                    <div class="guidance-rule-item">
                                        <div class="rule-pattern">
                                            题目模式：${rule.question_pattern || '未知模式'}
                                        </div>
                                        <div class="rule-answer">
                                            推荐答案：${rule.recommended_answer || '未知答案'}
                                        </div>
                                        <div class="rule-confidence">
                                            可信度：${(rule.confidence * 100).toFixed(0)}% | 
                                            成功率：${rule.success_rate ? (rule.success_rate * 100).toFixed(0) + '%' : '未知'}
                                        </div>
                                        ${rule.reasoning ? `<div style="margin-top: 0.3rem; font-style: italic; color: #666;">推理：${rule.reasoning}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // 格式化目标人群信息
        function formatTargetAudience(audience) {
            if (!audience) return '未知';
            
            const parts = [];
            if (audience.age_range) parts.push(`年龄: ${audience.age_range}`);
            if (audience.gender) parts.push(`性别: ${audience.gender}`);
            if (audience.occupation) parts.push(`职业: ${audience.occupation}`);
            if (audience.education) parts.push(`学历: ${audience.education}`);
            
            return parts.length > 0 ? parts.join(', ') : '未知';
        }

        // 获取可信度样式类
        function getConfidenceClass(score) {
            if (!score) return 'low';
            if (score >= 0.8) return 'high';
            if (score >= 0.6) return 'medium';
            return 'low';
        }

        // 生成敢死队经验详情
        function generateScoutExperiencesDetails(scoutPhase) {
            if (!scoutPhase || !scoutPhase.scout_experiences) return '';
            
            return `
                <div class="experience-card">
                    <h5>🔍 敢死队侦察经验详情</h5>
                    <div style="margin-bottom: 1rem; color: #666;">
                        总计：${scoutPhase.scout_experiences.length}条经验 | 
                        成功率：${(scoutPhase.success_rate * 100).toFixed(1)}%
                    </div>
                    <div class="scout-experiences">
                        ${scoutPhase.scout_experiences.map(exp => `
                            <div class="scout-experience-item">
                                <div class="scout-name">
                                    ${exp.scout_name || '未知成员'} - 第${exp.page_number || 0}页
                                    ${exp.success ? '✅' : '❌'}
                                </div>
                                <div class="experience-details">
                                    ${exp.questions_answered && exp.questions_answered.length > 0 ? 
                                        `回答了 ${exp.questions_answered.length} 个问题` : 
                                        '无答题记录'
                                    }
                                    ${exp.failure_reason ? `<br><span style="color: #dc3545;">失败原因：${exp.failure_reason}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 生成大部队结果详情
        function generateTargetResultsDetails(targetPhase) {
            if (!targetPhase || !targetPhase.target_results) return '';
            
            return `
                <div class="experience-card">
                    <h5>⚔️ 大部队执行详情</h5>
                    <div style="margin-bottom: 1rem; color: #666;">
                        总计：${targetPhase.target_results.length}人 | 
                        成功率：${(targetPhase.success_rate * 100).toFixed(1)}% |
                        相似成员：${targetPhase.similar_members || 0}人 |
                        多样化成员：${targetPhase.diverse_members || 0}人
                    </div>
                    <div class="target-results">
                        ${targetPhase.target_results.map(result => `
                            <div class="target-result-item ${result.success ? '' : 'failed'}">
                                <div class="target-name">
                                    ${result.target_name || '未知成员'} ${result.success ? '✅' : '❌'}
                                </div>
                                <div class="result-details">
                                    执行时间：${result.execution_time || 0}秒 | 
                                    指导规则：${result.guided_by_rules || 0}条
                                    ${result.error ? `<br><span style="color: #dc3545;">错误：${result.error}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // 生成传统结果
        function generateTraditionalResults(results) {
            const scoutPhase = results.scout_phase || {};
            const targetPhase = results.target_phase || {};
            const overall = results.overall || {};
            
            return `
                <div class="results-section">
                    <h4>📊 传统模式执行结果</h4>
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>🔍 敢死队阶段</h4>
                            <div class="result-value">${(scoutPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                成功率 (${scoutPhase.successful || 0}/${scoutPhase.total || 0})
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>🎯 大部队阶段</h4>
                            <div class="result-value">${(targetPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                成功率 (${targetPhase.successful || 0}/${targetPhase.total || 0})
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>📈 总体效果</h4>
                            <div class="result-value">${(overall.overall_success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                整体成功率<br>
                                总答题: ${overall.total_answers || 0}题
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>💰 资源消耗</h4>
                            <div class="result-value">$${(results.total_cost || 0).toFixed(4)}</div>
                            <div class="result-description">
                                总成本
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 计算进度
        function calculateProgress(task) {
            const total = task.progress.total_phases;
            const current = task.progress.current_phase;
            
            if (task.status === 'completed') {
                return 100;
            }
            
            if (task.status === 'failed') {
                return (current - 1) / total * 100;
            }
            
            // 基于完成的阶段计算
            let completed = 0;
            if (task.progress.phase1_complete) completed++;
            if (task.progress.phase2_complete) completed++;
            if (task.progress.phase3_complete) completed++;
            if (task.progress.phase4_complete) completed++;
            
            return (completed / total) * 100;
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'running': return 'running';
                case 'completed': return 'completed';
                case 'failed': return 'failed';
                default: return 'created';
            }
        }
    </script>
</body>
</html>