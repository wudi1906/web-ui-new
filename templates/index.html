<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é—®å·å¡«å†™ç³»ç»Ÿ - ä¸‰é˜¶æ®µæ™ºèƒ½æ ¸å¿ƒç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 1rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .mode-card {
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .mode-card.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mode-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .mode-card h3 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .mode-card .features {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .mode-card .badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #27ae60;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .advanced-options {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .advanced-options h4 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        .param-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .status-item {
            text-align: center;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .status-item .label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }

        .status-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .status-item.online .value {
            color: #27ae60;
        }

        .status-item.offline .value {
            color: #e74c3c;
        }

        .task-panel {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e1e8ed;
        }

        .task-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 0.3rem 0.6rem;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .task-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .task-status.running {
            background: #3498db;
            color: white;
        }

        .task-status.completed {
            background: #27ae60;
            color: white;
        }

        .task-status.failed {
            background: #e74c3c;
            color: white;
        }

        .task-status.created {
            background: #f39c12;
            color: white;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e1e8ed;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .phase-details {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .phase-step {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 5px;
        }

        .phase-step.active {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .phase-step.completed {
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }

        .phase-step .icon {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        .results-section {
            margin-top: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .result-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .result-card h4 {
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #667eea;
        }

        .result-description {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e1e8ed;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .text-center { text-align: center; }

        /* ç»éªŒåˆ†æä¸“ç”¨æ ·å¼ */
        .experience-section {
            margin-top: 1.5rem;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
        }

        .experience-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .experience-card h5 {
            margin-bottom: 0.8rem;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 0.5rem;
        }

        .scout-experiences {
            max-height: 300px;
            overflow-y: auto;
        }

        .scout-experience-item {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .scout-experience-item .scout-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.3rem;
        }

        .scout-experience-item .experience-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .analysis-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .analysis-item strong {
            min-width: 120px;
            color: #2c3e50;
            margin-right: 0.5rem;
        }

        .analysis-item span {
            color: #495057;
        }

        .trap-questions {
            max-height: 150px;
            overflow-y: auto;
        }

        .trap-question-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .success-patterns {
            max-height: 150px;
            overflow-y: auto;
        }

        .success-pattern-item {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.3rem;
            font-size: 0.9rem;
        }

        .guidance-rules {
            max-height: 200px;
            overflow-y: auto;
        }

        .guidance-rule-item {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 4px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .guidance-rule-item .rule-pattern {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 0.3rem;
        }

        .guidance-rule-item .rule-answer {
            color: #388e3c;
            margin-bottom: 0.3rem;
        }

        .guidance-rule-item .rule-confidence {
            font-size: 0.8rem;
            color: #757575;
        }

        .confidence-score {
            font-weight: bold;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            color: white;
        }

        .confidence-score.high { background: #4caf50; }
        .confidence-score.medium { background: #ff9800; }
        .confidence-score.low { background: #f44336; }

        .target-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .target-result-item {
            background: #f8f9fa;
            border-left: 4px solid #28a745;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .target-result-item.failed {
            background: #fff5f5;
            border-left: 4px solid #dc3545;
        }

        .target-result-item .target-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .target-result-item .result-details {
            font-size: 0.9rem;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .mode-selection {
                grid-template-columns: 1fr;
            }
            
            .param-grid {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }

            .experience-section {
                padding: 1rem;
            }

            .experience-card {
                padding: 0.8rem;
            }
        }

        /* ğŸ†• æ–°å¢ï¼šåŠ è½½åŠ¨ç”»æ ·å¼ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        /* Geminiåˆ†æåŒºåŸŸæ ·å¼ */
        #gemini-analysis-section {
            border: 2px solid #667eea !important;
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%) !important;
        }
        
        .analysis-item {
            margin-bottom: 0.8rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .analysis-item:last-child {
            border-bottom: none;
        }
        
        .confidence-score {
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .confidence-score.high {
            background: #d4edda;
            color: #155724;
        }
        
        .confidence-score.medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .confidence-score.low {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ§  æ™ºèƒ½é—®å·å¡«å†™ç³»ç»Ÿ</h1>
        <p class="subtitle">ä¸‰é˜¶æ®µæ™ºèƒ½æ ¸å¿ƒç‰ˆ - æ•¢æ­»é˜Ÿæƒ…æŠ¥æ”¶é›† â†’ Geminiåˆ†æ â†’ å¤§éƒ¨é˜ŸæŒ‡å¯¼ä½œæˆ˜</p>
    </div>

    <div class="container">
        <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
        <div class="card">
            <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
            <div class="status-panel">
                <div class="status-grid" id="systemStatus">
                    <div class="status-item">
                        <div class="label">ä¸‰é˜¶æ®µæ™ºèƒ½ç³»ç»Ÿ</div>
                        <div class="value" id="threeStageStatus">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <div class="label">ä¼ ç»Ÿç³»ç»Ÿ</div>
                        <div class="value" id="enhancedStatus">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <div class="label">çŸ¥è¯†åº“API</div>
                        <div class="value" id="knowledgeStatus">æ£€æŸ¥ä¸­...</div>
                    </div>
                    <div class="status-item">
                        <div class="label">æ´»è·ƒä»»åŠ¡</div>
                        <div class="value" id="activeTaskCount">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡åˆ›å»ºé¢æ¿ -->
        <div class="card">
            <h2>ğŸš€ åˆ›å»ºæ–°ä»»åŠ¡</h2>
            
            <!-- æ¨¡å¼é€‰æ‹© -->
            <div class="form-group">
                <label>é€‰æ‹©æ‰§è¡Œæ¨¡å¼</label>
                <div class="mode-selection">
                    <div class="mode-card active" data-mode="three_stage">
                        <div class="badge">æ¨è</div>
                        <h3>ğŸ§  ä¸‰é˜¶æ®µæ™ºèƒ½æ¨¡å¼</h3>
                        <div class="features">
                            æ•¢æ­»é˜Ÿæƒ…æŠ¥æ”¶é›†<br>
                            Geminiæ™ºèƒ½åˆ†æ<br>
                            å¤§éƒ¨é˜ŸæŒ‡å¯¼ä½œæˆ˜<br>
                            é«˜æˆåŠŸç‡ä¿è¯
                        </div>
                    </div>
                    <div class="mode-card" data-mode="traditional">
                        <h3>âš¡ ä¼ ç»Ÿæ¨¡æ‹Ÿæ¨¡å¼</h3>
                        <div class="features">
                            å¿«é€Ÿæ¨¡æ‹Ÿæ‰§è¡Œ<br>
                            åŸºç¡€æ•°æ®åˆ†æ<br>
                            å…¼å®¹æ€§æµ‹è¯•<br>
                            æ¼”ç¤ºåŠŸèƒ½
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŸºç¡€å‚æ•° -->
            <div class="form-group">
                <label for="questionnaireUrl">é—®å·URL</label>
                <input type="url" id="questionnaireUrl" placeholder="è¯·è¾“å…¥é—®å·é“¾æ¥ï¼Œä¾‹å¦‚: https://www.wjx.cn/vm/example.aspx" required>
            </div>

            <!-- é«˜çº§é€‰é¡¹ -->
            <div class="advanced-options">
                <h4>âš™ï¸ é«˜çº§å‚æ•°</h4>
                <div class="param-grid">
                    <div class="form-group">
                        <label for="scoutCount">æ•¢æ­»é˜Ÿæ•°é‡</label>
                        <select id="scoutCount">
                            <option value="1" selected>1äººï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰</option>
                            <option value="2">2äººï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰</option>
                            <option value="3">3äººï¼ˆæ¨èï¼‰</option>
                            <option value="5">5äººï¼ˆæ·±åº¦æ¢ç´¢ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="targetCount">å¤§éƒ¨é˜Ÿæ•°é‡</label>
                        <select id="targetCount">
                            <option value="2" selected>2äººï¼ˆæµ‹è¯•æ¨¡å¼ï¼‰</option>
                            <option value="5">5äººï¼ˆå¿«é€Ÿï¼‰</option>
                            <option value="10">10äººï¼ˆæ ‡å‡†ï¼‰</option>
                            <option value="20">20äººï¼ˆæ‰©å±•ï¼‰</option>
                        </select>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="createTask()" id="createBtn">
                ğŸš€ å¯åŠ¨æ™ºèƒ½é—®å·ä»»åŠ¡
            </button>
        </div>

        <!-- æ´»è·ƒä»»åŠ¡æ˜¾ç¤º -->
        <div id="activeTasksContainer" class="hidden">
            <div class="card">
                <h2>ğŸ“‹ å½“å‰ä»»åŠ¡</h2>
                <div id="activeTasksList"></div>
            </div>
        </div>

        <!-- ä»»åŠ¡å†å²æ˜¾ç¤º -->
        <div id="taskHistoryContainer" class="hidden">
            <div class="card">
                <h2>ğŸ“ˆ ä»»åŠ¡å†å²</h2>
                <div id="taskHistoryList"></div>
            </div>
        </div>
    </div>

    <script>
        let selectedMode = 'three_stage';
        let currentTask = null;
        let refreshInterval = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeSystem();
            checkSystemStatus();
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            setInterval(checkSystemStatus, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€
        });

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initializeSystem() {
            // æ¨¡å¼é€‰æ‹©äº‹ä»¶
            document.querySelectorAll('.mode-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectMode(this.dataset.mode);
                });
            });
        }

        // é€‰æ‹©æ¨¡å¼
        function selectMode(mode) {
            selectedMode = mode;
            
            // æ›´æ–°UI
            document.querySelectorAll('.mode-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const btn = document.getElementById('createBtn');
            if (mode === 'three_stage') {
                btn.textContent = 'ğŸ§  å¯åŠ¨ä¸‰é˜¶æ®µæ™ºèƒ½ä»»åŠ¡';
            } else {
                btn.textContent = 'âš¡ å¯åŠ¨ä¼ ç»Ÿæ¨¡æ‹Ÿä»»åŠ¡';
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            try {
                const response = await fetch('/system_status');
                const data = await response.json();
                
                updateStatusDisplay('threeStageStatus', data.three_stage_system_available, 'å·²å¯ç”¨', 'æœªå¯ç”¨');
                updateStatusDisplay('enhancedStatus', data.enhanced_system_available, 'å·²å¯ç”¨', 'æœªå¯ç”¨');
                updateStatusDisplay('knowledgeStatus', data.knowledge_api_available, 'åœ¨çº¿', 'ç¦»çº¿');
                
                document.getElementById('activeTaskCount').textContent = data.active_tasks_count;
                
            } catch (error) {
                console.error('æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
                updateStatusDisplay('threeStageStatus', false, 'å·²å¯ç”¨', 'è¿æ¥å¤±è´¥');
                updateStatusDisplay('enhancedStatus', false, 'å·²å¯ç”¨', 'è¿æ¥å¤±è´¥');
                updateStatusDisplay('knowledgeStatus', false, 'åœ¨çº¿', 'è¿æ¥å¤±è´¥');
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatusDisplay(elementId, isOnline, onlineText, offlineText) {
            const element = document.getElementById(elementId);
            element.textContent = isOnline ? onlineText : offlineText;
            element.parentElement.className = `status-item ${isOnline ? 'online' : 'offline'}`;
        }

        // åˆ›å»ºä»»åŠ¡
        async function createTask() {
            const url = document.getElementById('questionnaireUrl').value.trim();
            const scoutCount = parseInt(document.getElementById('scoutCount').value);
            const targetCount = parseInt(document.getElementById('targetCount').value);
            
            // éªŒè¯è¾“å…¥
            if (!url) {
                alert('è¯·è¾“å…¥é—®å·URL');
                return;
            }
            
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€ï¼ˆå¿…é¡»ä»¥http://æˆ–https://å¼€å¤´ï¼‰');
                return;
            }
            
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'ğŸš€ æ­£åœ¨åˆ›å»ºä»»åŠ¡...';
            
            try {
                const response = await fetch('/create_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        questionnaire_url: url,
                        scout_count: scoutCount,
                        target_count: targetCount,
                        task_mode: selectedMode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentTask = data.task_id;
                    alert(`âœ… ${data.message}\nä»»åŠ¡ID: ${data.task_id}`);
                    
                    // å¼€å§‹ç›‘æ§ä»»åŠ¡
                    startTaskMonitoring(data.task_id);
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('questionnaireUrl').value = '';
                    
                } else {
                    alert(`âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ${data.error}`);
                }
                
            } catch (error) {
                console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                alert(`âŒ åˆ›å»ºä»»åŠ¡å¤±è´¥: ${error.message}`);
            } finally {
                createBtn.disabled = false;
                selectMode(selectedMode); // æ¢å¤æŒ‰é’®æ–‡æœ¬
            }
        }

        // å¼€å§‹ä»»åŠ¡ç›‘æ§
        function startTaskMonitoring(taskId) {
            // åœæ­¢ä¹‹å‰çš„ç›‘æ§
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            // ç«‹å³åˆ·æ–°ä¸€æ¬¡
            refreshTask(taskId);
            
            // è®¾ç½®å®šæ—¶åˆ·æ–°
            refreshInterval = setInterval(() => {
                refreshTask(taskId);
            }, 2000);
        }

        // åˆ·æ–°ä»»åŠ¡çŠ¶æ€
        function refreshTask(taskId) {
            fetch(`/refresh_task/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateTaskDisplay(data.task);
                        
                        // ğŸ†• æ–°å¢ï¼šå¦‚æœä»»åŠ¡è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œè·å–Geminiåˆ†æç»“æœ
                        if (data.task.progress && data.task.progress.current_phase >= 2) {
                            fetchGeminiAnalysis(taskId);
                        }
                    }
                })
                .catch(error => {
                    console.error('åˆ·æ–°ä»»åŠ¡å¤±è´¥:', error);
                });
        }
        
        // ğŸ†• æ–°å¢ï¼šè·å–Geminiæˆªå›¾åˆ†æç»“æœ
        function fetchGeminiAnalysis(taskId) {
            fetch(`/get_gemini_analysis/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.has_analysis) {
                        displayGeminiAnalysis(data.gemini_analysis);
                    } else {
                        displayGeminiAnalysisPlaceholder(data.message || 'æš‚æ— Geminiåˆ†æç»“æœ');
                    }
                })
                .catch(error => {
                    console.error('è·å–Geminiåˆ†æå¤±è´¥:', error);
                    displayGeminiAnalysisPlaceholder('è·å–Geminiåˆ†æå¤±è´¥');
                });
        }
        
        // ğŸ†• æ–°å¢ï¼šæ˜¾ç¤ºGeminiåˆ†æç»“æœ
        function displayGeminiAnalysis(analysisData) {
            const contentDiv = document.getElementById('gemini-analysis-content');
            if (!contentDiv) return;
            
            const guidancePreview = analysisData.guidance_preview || 'æ— æŒ‡å¯¼å†…å®¹';
            const bestScout = analysisData.best_scout || 'æœªçŸ¥';
            const analysisTime = analysisData.analysis_time ? new Date(analysisData.analysis_time).toLocaleString() : 'æœªçŸ¥æ—¶é—´';
            const screenshotPath = analysisData.screenshot_filepath || '';
            
            contentDiv.innerHTML = `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="font-weight: bold; color: #667eea;">ğŸ“¸ åŸºäºæœ€æˆåŠŸæ•¢æ­»é˜Ÿæˆªå›¾çš„AIåˆ†æ</span>
                        <span style="font-size: 0.9rem; color: #666;">${analysisTime}</span>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>åˆ†ææ¥æºï¼š</strong>æ•¢æ­»é˜Ÿ "${bestScout}" çš„æˆåŠŸæˆªå›¾
                    </div>
                    <div style="background: #f8f9ff; padding: 12px; border-radius: 6px; border-left: 4px solid #667eea;">
                        <strong>ğŸ¯ å¤§éƒ¨é˜Ÿä½œç­”ç»éªŒæŒ‡å¯¼ï¼š</strong><br>
                        <div style="margin-top: 8px; line-height: 1.6; color: #333;">
                            ${guidancePreview}
                        </div>
                    </div>
                    ${screenshotPath ? `
                        <div style="margin-top: 10px; font-size: 0.9rem; color: #666;">
                            ğŸ“ å¤„ç†åæˆªå›¾å·²ä¿å­˜: ${screenshotPath.split('/').pop()}
                        </div>
                    ` : ''}
                </div>
                <div style="text-align: center; margin-top: 10px;">
                    <button onclick="fetchProcessedScreenshots()" style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                        æŸ¥çœ‹æ‰€æœ‰å¤„ç†åæˆªå›¾
                    </button>
                </div>
            `;
        }
        
        // ğŸ†• æ–°å¢ï¼šæ˜¾ç¤ºGeminiåˆ†æå ä½ç¬¦
        function displayGeminiAnalysisPlaceholder(message) {
            const contentDiv = document.getElementById('gemini-analysis-content');
            if (!contentDiv) return;
            
            contentDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ¤–</div>
                    <div>${message}</div>
                    <div style="margin-top: 10px; font-size: 0.9rem;">
                        Geminiæˆªå›¾åˆ†æå°†åœ¨æ•¢æ­»é˜Ÿå®Œæˆåè‡ªåŠ¨è¿›è¡Œ
                    </div>
                </div>
            `;
        }
        
        // ğŸ†• æ–°å¢ï¼šè·å–å¤„ç†åæˆªå›¾åˆ—è¡¨
        function fetchProcessedScreenshots() {
            fetch('/get_processed_screenshots')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayProcessedScreenshots(data.screenshots, data.total_count);
                    } else {
                        alert('è·å–æˆªå›¾åˆ—è¡¨å¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('è·å–æˆªå›¾åˆ—è¡¨å¤±è´¥:', error);
                    alert('è·å–æˆªå›¾åˆ—è¡¨å¤±è´¥');
                });
        }
        
        // ğŸ†• æ–°å¢ï¼šæ˜¾ç¤ºå¤„ç†åæˆªå›¾åˆ—è¡¨
        function displayProcessedScreenshots(screenshots, totalCount) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                justify-content: center; align-items: center;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white; border-radius: 10px; padding: 20px; 
                max-width: 80%; max-height: 80%; overflow-y: auto;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            
            content.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ğŸ“¸ å¤„ç†åæˆªå›¾åˆ—è¡¨ (å…±${totalCount}å¼ )</h3>
                    <button onclick="this.closest('.modal').remove()" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">å…³é—­</button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                    ${screenshots.map(screenshot => `
                        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: #f9f9f9;">
                            <div style="font-weight: bold; margin-bottom: 8px; color: #333;">
                                ${screenshot.filename}
                            </div>
                            <div style="font-size: 0.9rem; color: #666; line-height: 1.4;">
                                <div><strong>ç±»å‹:</strong> ${screenshot.analysis_type}</div>
                                <div><strong>å¤§å°:</strong> ${screenshot.size_kb} KB</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(screenshot.created_time).toLocaleString()}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(content);
            document.body.appendChild(modal);
        }

        // æ˜¾ç¤ºä»»åŠ¡
        function displayTask(task, isCompleted) {
            const container = document.getElementById('activeTasksContainer');
            const tasksList = document.getElementById('activeTasksList');
            
            container.classList.remove('hidden');
            
            const taskHtml = generateTaskHtml(task, isCompleted);
            tasksList.innerHTML = taskHtml;
        }

        // ç”Ÿæˆä»»åŠ¡HTML
        function generateTaskHtml(task, isCompleted) {
            const progress = calculateProgress(task);
            const statusClass = getStatusClass(task.status);
            
            let phaseDetailsHtml = '';
            if (task.task_mode === 'three_stage') {
                phaseDetailsHtml = generateThreeStagePhaseDetails(task);
            } else {
                phaseDetailsHtml = generateTraditionalPhaseDetails(task);
            }
            
            let resultsHtml = '';
            if (isCompleted && task.results) {
                resultsHtml = generateResultsHtml(task.results, task.task_mode);
            }
            
            return `
                <div class="task-panel">
                    <div class="task-header">
                        <div>
                            <div class="task-id">ä»»åŠ¡ID: ${task.task_id}</div>
                            <div class="mt-2">
                                <strong>æ¨¡å¼:</strong> ${task.task_mode === 'three_stage' ? 'ğŸ§  ä¸‰é˜¶æ®µæ™ºèƒ½æ¨¡å¼' : 'âš¡ ä¼ ç»Ÿæ¨¡æ‹Ÿæ¨¡å¼'}
                            </div>
                            <div><strong>é—®å·:</strong> ${task.questionnaire_url}</div>
                            <div><strong>æ•¢æ­»é˜Ÿ:</strong> ${task.scout_count}äºº | <strong>å¤§éƒ¨é˜Ÿ:</strong> ${task.target_count}äºº</div>
                        </div>
                        <div class="task-status ${statusClass}">
                            ${task.status}
                        </div>
                    </div>
                    
                    <div><strong>å½“å‰é˜¶æ®µ:</strong> ${task.phase}</div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="text-center" style="font-size: 0.9rem; color: #7f8c8d;">
                        è¿›åº¦: ${progress}% (ç¬¬${task.progress.current_phase}é˜¶æ®µ/å…±${task.progress.total_phases}é˜¶æ®µ)
                    </div>
                    
                    ${phaseDetailsHtml}
                    
                    ${resultsHtml}
                </div>
            `;
        }

        // ç”Ÿæˆä¸‰é˜¶æ®µæµç¨‹è¯¦æƒ…
        function generateThreeStagePhaseDetails(task) {
            const phases = [
                { key: 'phase1_complete', name: 'ç¬¬ä¸€é˜¶æ®µï¼šæ•¢æ­»é˜Ÿæƒ…æŠ¥æ”¶é›†', icon: 'ğŸ”' },
                { key: 'phase2_complete', name: 'ç¬¬äºŒé˜¶æ®µï¼šGeminiæ™ºèƒ½åˆ†æ', icon: 'ğŸ§ ' },
                { key: 'phase3_complete', name: 'ç¬¬ä¸‰é˜¶æ®µï¼šå¤§éƒ¨é˜Ÿæ‹›å‹Ÿé€‰æ‹©', icon: 'ğŸ‘¥' },
                { key: 'phase4_complete', name: 'ç¬¬å››é˜¶æ®µï¼šæ™ºèƒ½æŒ‡å¯¼ä½œæˆ˜', icon: 'ğŸ¯' }
            ];
            
            return `
                <div class="phase-details">
                    <h4>ğŸ“‹ ä¸‰é˜¶æ®µæ™ºèƒ½æµç¨‹</h4>
                    ${phases.map((phase, index) => {
                        const isActive = task.progress.current_phase === index + 1;
                        const isCompleted = task.progress[phase.key];
                        const stepClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
                        
                        return `
                            <div class="phase-step ${stepClass}">
                                <span class="icon">${phase.icon}</span>
                                <span>${phase.name}</span>
                                ${isCompleted ? '<span style="margin-left: auto;">âœ…</span>' : ''}
                                ${isActive && !isCompleted ? '<span style="margin-left: auto;">â³</span>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ç”Ÿæˆä¼ ç»Ÿæµç¨‹è¯¦æƒ…
        function generateTraditionalPhaseDetails(task) {
            const phases = [
                { key: 'phase1_complete', name: 'é˜¶æ®µ1ï¼šåŸºç¡€è®¾æ–½å‡†å¤‡', icon: 'âš™ï¸' },
                { key: 'phase2_complete', name: 'é˜¶æ®µ2ï¼šé—®å·æ‰§è¡Œ', icon: 'ğŸ“' }
            ];
            
            return `
                <div class="phase-details">
                    <h4>ğŸ“‹ ä¼ ç»Ÿæ‰§è¡Œæµç¨‹</h4>
                    ${phases.map((phase, index) => {
                        const isActive = task.progress.current_phase === index + 1;
                        const isCompleted = task.progress[phase.key];
                        const stepClass = isCompleted ? 'completed' : (isActive ? 'active' : '');
                        
                        return `
                            <div class="phase-step ${stepClass}">
                                <span class="icon">${phase.icon}</span>
                                <span>${phase.name}</span>
                                ${isCompleted ? '<span style="margin-left: auto;">âœ…</span>' : ''}
                                ${isActive && !isCompleted ? '<span style="margin-left: auto;">â³</span>' : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // ç”Ÿæˆç»“æœHTML
        function generateResultsHtml(results, taskMode) {
            if (taskMode === 'three_stage') {
                return generateThreeStageResults(results);
            } else {
                return generateTraditionalResults(results);
            }
        }

        // ç”Ÿæˆä¸‰é˜¶æ®µç»“æœ
        function generateThreeStageResults(results) {
            const scoutPhase = results.scout_phase || {};
            const analysisPhase = results.analysis_phase || {};
            const targetPhase = results.target_phase || {};
            const overall = results.overall || {};
            
            return `
                <div class="results-section">
                    <h4>ğŸ“Š ä¸‰é˜¶æ®µæ™ºèƒ½æ‰§è¡Œç»“æœ</h4>
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>ğŸ” æ•¢æ­»é˜Ÿé˜¶æ®µ</h4>
                            <div class="result-value">${(scoutPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                æˆåŠŸç‡ (${scoutPhase.successful_scouts || 0}/${scoutPhase.total_scouts || 0})<br>
                                æ”¶é›†ç»éªŒ: ${scoutPhase.experiences_collected || 0}æ¡
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ§  æ™ºèƒ½åˆ†æ</h4>
                            <div class="result-value">${(analysisPhase.confidence_score * 100).toFixed(0)}%</div>
                            <div class="result-description">
                                åˆ†æå¯ä¿¡åº¦<br>
                                ç”Ÿæˆè§„åˆ™: ${analysisPhase.guidance_rules_generated || 0}æ¡
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ¯ å¤§éƒ¨é˜Ÿé˜¶æ®µ</h4>
                            <div class="result-value">${(targetPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                æˆåŠŸç‡ (${targetPhase.successful_targets || 0}/${targetPhase.total_targets || 0})<br>
                                ç›¸ä¼¼æˆå‘˜: ${targetPhase.similar_members || 0}äºº
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ“ˆ æ€»ä½“æ•ˆæœ</h4>
                            <div class="result-value">${(overall.overall_success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                æ•´ä½“æˆåŠŸç‡<br>
                                æå‡: ${(overall.improvement_rate * 100).toFixed(1)}%
                            </div>
                        </div>
                    </div>
                    
                    ${generateIntelligenceAnalysisDetails(analysisPhase.intelligence_analysis)}
                    
                    ${generateScoutExperiencesDetails(scoutPhase)}
                    
                    ${generateTargetResultsDetails(targetPhase)}
                </div>
            `;
        }

        // ç”Ÿæˆæ™ºèƒ½åˆ†æè¯¦æƒ…
        function generateIntelligenceAnalysisDetails(intelligence) {
            if (!intelligence) return '';
            
            return `
                <div class="experience-section">
                    <h4>ğŸ§  æ™ºèƒ½åˆ†æè¯¦æƒ…</h4>
                    
                    <!-- ğŸ†• æ–°å¢ï¼šGeminiæˆªå›¾åˆ†æç»“æœæ˜¾ç¤º -->
                    <div id="gemini-analysis-section" class="experience-card" style="border: 2px solid #667eea; background: linear-gradient(135deg, #f8f9ff 0%, #e8f0ff 100%);">
                        <h5>ğŸ“¸ Geminiæˆªå›¾åˆ†ææŒ‡å¯¼</h5>
                        <div id="gemini-analysis-content">
                            <div style="text-align: center; color: #666; padding: 20px;">
                                <div class="loading-spinner" style="display: inline-block; width: 20px; height: 20px; border: 2px solid #ddd; border-top: 2px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span style="margin-left: 10px;">æ­£åœ¨è·å–Geminiæˆªå›¾åˆ†æç»“æœ...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- åŸºæœ¬åˆ†æä¿¡æ¯ -->
                    <div class="experience-card">
                        <h5>ğŸ“Š åŸºç¡€åˆ†æ</h5>
                        <div class="analysis-item">
                            <strong>é—®å·ä¸»é¢˜ï¼š</strong>
                            <span>${intelligence.questionnaire_theme || 'æœªçŸ¥'}</span>
                        </div>
                        <div class="analysis-item">
                            <strong>ç›®æ ‡äººç¾¤ï¼š</strong>
                            <span>${formatTargetAudience(intelligence.target_audience)}</span>
                        </div>
                        <div class="analysis-item">
                            <strong>åˆ†æå¯ä¿¡åº¦ï¼š</strong>
                            <span class="confidence-score ${getConfidenceClass(intelligence.confidence_score)}">
                                ${(intelligence.confidence_score * 100).toFixed(0)}%
                            </span>
                        </div>
                    </div>

                    <!-- é™·é˜±é¢˜ç›®åˆ†æ -->
                    ${intelligence.trap_questions && intelligence.trap_questions.length > 0 ? `
                        <div class="experience-card">
                            <h5>âš ï¸ é™·é˜±é¢˜ç›®è¯†åˆ«</h5>
                            <div class="trap-questions">
                                ${intelligence.trap_questions.map(trap => `
                                    <div class="trap-question-item">
                                        <strong>é¢˜ç›®ï¼š</strong>${trap.question || 'æœªçŸ¥é¢˜ç›®'}<br>
                                        <strong>é™·é˜±ç±»å‹ï¼š</strong>${trap.trap_type || 'æœªçŸ¥ç±»å‹'}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- æˆåŠŸæ¨¡å¼åˆ†æ -->
                    ${intelligence.success_patterns && intelligence.success_patterns.length > 0 ? `
                        <div class="experience-card">
                            <h5>âœ… æˆåŠŸæ¨¡å¼è¯†åˆ«</h5>
                            <div class="success-patterns">
                                ${intelligence.success_patterns.map(pattern => `
                                    <div class="success-pattern-item">
                                        <strong>æ¨¡å¼ï¼š</strong>${pattern.pattern || 'æœªçŸ¥æ¨¡å¼'}<br>
                                        <strong>æˆåŠŸç‡ï¼š</strong>${(pattern.success_rate * 100).toFixed(1)}%
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- æŒ‡å¯¼è§„åˆ™ -->
                    ${intelligence.guidance_rules && intelligence.guidance_rules.length > 0 ? `
                        <div class="experience-card">
                            <h5>ğŸ“‹ ç”Ÿæˆçš„æ™ºèƒ½æŒ‡å¯¼è§„åˆ™</h5>
                            <div class="guidance-rules">
                                ${intelligence.guidance_rules.map(rule => `
                                    <div class="guidance-rule-item">
                                        <div class="rule-pattern">
                                            é¢˜ç›®æ¨¡å¼ï¼š${rule.question_pattern || 'æœªçŸ¥æ¨¡å¼'}
                                        </div>
                                        <div class="rule-answer">
                                            æ¨èç­”æ¡ˆï¼š${rule.recommended_answer || 'æœªçŸ¥ç­”æ¡ˆ'}
                                        </div>
                                        <div class="rule-confidence">
                                            å¯ä¿¡åº¦ï¼š${(rule.confidence * 100).toFixed(0)}% | 
                                            æˆåŠŸç‡ï¼š${rule.success_rate ? (rule.success_rate * 100).toFixed(0) + '%' : 'æœªçŸ¥'}
                                        </div>
                                        ${rule.reasoning ? `<div style="margin-top: 0.3rem; font-style: italic; color: #666;">æ¨ç†ï¼š${rule.reasoning}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // æ ¼å¼åŒ–ç›®æ ‡äººç¾¤ä¿¡æ¯
        function formatTargetAudience(audience) {
            if (!audience) return 'æœªçŸ¥';
            
            const parts = [];
            if (audience.age_range) parts.push(`å¹´é¾„: ${audience.age_range}`);
            if (audience.gender) parts.push(`æ€§åˆ«: ${audience.gender}`);
            if (audience.occupation) parts.push(`èŒä¸š: ${audience.occupation}`);
            if (audience.education) parts.push(`å­¦å†: ${audience.education}`);
            
            return parts.length > 0 ? parts.join(', ') : 'æœªçŸ¥';
        }

        // è·å–å¯ä¿¡åº¦æ ·å¼ç±»
        function getConfidenceClass(score) {
            if (!score) return 'low';
            if (score >= 0.8) return 'high';
            if (score >= 0.6) return 'medium';
            return 'low';
        }

        // ç”Ÿæˆæ•¢æ­»é˜Ÿç»éªŒè¯¦æƒ…
        function generateScoutExperiencesDetails(scoutPhase) {
            if (!scoutPhase || !scoutPhase.scout_experiences) return '';
            
            return `
                <div class="experience-card">
                    <h5>ğŸ” æ•¢æ­»é˜Ÿä¾¦å¯Ÿç»éªŒè¯¦æƒ…</h5>
                    <div style="margin-bottom: 1rem; color: #666;">
                        æ€»è®¡ï¼š${scoutPhase.scout_experiences.length}æ¡ç»éªŒ | 
                        æˆåŠŸç‡ï¼š${(scoutPhase.success_rate * 100).toFixed(1)}%
                    </div>
                    <div class="scout-experiences">
                        ${scoutPhase.scout_experiences.map(exp => `
                            <div class="scout-experience-item">
                                <div class="scout-name">
                                    ${exp.scout_name || 'æœªçŸ¥æˆå‘˜'} - ç¬¬${exp.page_number || 0}é¡µ
                                    ${exp.success ? 'âœ…' : 'âŒ'}
                                </div>
                                <div class="experience-details">
                                    ${exp.questions_answered && exp.questions_answered.length > 0 ? 
                                        `å›ç­”äº† ${exp.questions_answered.length} ä¸ªé—®é¢˜` : 
                                        'æ— ç­”é¢˜è®°å½•'
                                    }
                                    ${exp.failure_reason ? `<br><span style="color: #dc3545;">å¤±è´¥åŸå› ï¼š${exp.failure_reason}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ç”Ÿæˆå¤§éƒ¨é˜Ÿç»“æœè¯¦æƒ…
        function generateTargetResultsDetails(targetPhase) {
            if (!targetPhase || !targetPhase.target_results) return '';
            
            return `
                <div class="experience-card">
                    <h5>âš”ï¸ å¤§éƒ¨é˜Ÿæ‰§è¡Œè¯¦æƒ…</h5>
                    <div style="margin-bottom: 1rem; color: #666;">
                        æ€»è®¡ï¼š${targetPhase.target_results.length}äºº | 
                        æˆåŠŸç‡ï¼š${(targetPhase.success_rate * 100).toFixed(1)}% |
                        ç›¸ä¼¼æˆå‘˜ï¼š${targetPhase.similar_members || 0}äºº |
                        å¤šæ ·åŒ–æˆå‘˜ï¼š${targetPhase.diverse_members || 0}äºº
                    </div>
                    <div class="target-results">
                        ${targetPhase.target_results.map(result => `
                            <div class="target-result-item ${result.success ? '' : 'failed'}">
                                <div class="target-name">
                                    ${result.target_name || 'æœªçŸ¥æˆå‘˜'} ${result.success ? 'âœ…' : 'âŒ'}
                                </div>
                                <div class="result-details">
                                    æ‰§è¡Œæ—¶é—´ï¼š${result.execution_time || 0}ç§’ | 
                                    æŒ‡å¯¼è§„åˆ™ï¼š${result.guided_by_rules || 0}æ¡
                                    ${result.error ? `<br><span style="color: #dc3545;">é”™è¯¯ï¼š${result.error}</span>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ç”Ÿæˆä¼ ç»Ÿç»“æœ
        function generateTraditionalResults(results) {
            const scoutPhase = results.scout_phase || {};
            const targetPhase = results.target_phase || {};
            const overall = results.overall || {};
            
            return `
                <div class="results-section">
                    <h4>ğŸ“Š ä¼ ç»Ÿæ¨¡å¼æ‰§è¡Œç»“æœ</h4>
                    <div class="results-grid">
                        <div class="result-card">
                            <h4>ğŸ” æ•¢æ­»é˜Ÿé˜¶æ®µ</h4>
                            <div class="result-value">${(scoutPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                æˆåŠŸç‡ (${scoutPhase.successful || 0}/${scoutPhase.total || 0})
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ¯ å¤§éƒ¨é˜Ÿé˜¶æ®µ</h4>
                            <div class="result-value">${(targetPhase.success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                æˆåŠŸç‡ (${targetPhase.successful || 0}/${targetPhase.total || 0})
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ“ˆ æ€»ä½“æ•ˆæœ</h4>
                            <div class="result-value">${(overall.overall_success_rate * 100).toFixed(1)}%</div>
                            <div class="result-description">
                                æ•´ä½“æˆåŠŸç‡<br>
                                æ€»ç­”é¢˜: ${overall.total_answers || 0}é¢˜
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h4>ğŸ’° èµ„æºæ¶ˆè€—</h4>
                            <div class="result-value">$${(results.total_cost || 0).toFixed(4)}</div>
                            <div class="result-description">
                                æ€»æˆæœ¬
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // è®¡ç®—è¿›åº¦
        function calculateProgress(task) {
            const total = task.progress.total_phases;
            const current = task.progress.current_phase;
            
            if (task.status === 'completed') {
                return 100;
            }
            
            if (task.status === 'failed') {
                return (current - 1) / total * 100;
            }
            
            // åŸºäºå®Œæˆçš„é˜¶æ®µè®¡ç®—
            let completed = 0;
            if (task.progress.phase1_complete) completed++;
            if (task.progress.phase2_complete) completed++;
            if (task.progress.phase3_complete) completed++;
            if (task.progress.phase4_complete) completed++;
            
            return (completed / total) * 100;
        }

        // è·å–çŠ¶æ€æ ·å¼ç±»
        function getStatusClass(status) {
            switch (status) {
                case 'running': return 'running';
                case 'completed': return 'completed';
                case 'failed': return 'failed';
                default: return 'created';
            }
        }
    </script>
</body>
</html>