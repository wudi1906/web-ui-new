<!-- åœ¨ç¬¬ä¸€é˜¶æ®µè¯¦æƒ…å¼¹å‡ºæ¡†ä¸­æ·»åŠ è®¾å¤‡ç¯å¢ƒæ£€æŸ¥æ¿å— -->
<div id="deviceEnvironmentSection" class="device-environment-section" style="margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
    <h4 style="color: #2c3e50; margin-bottom: 15px;">ğŸ–¥ï¸ è®¾å¤‡ç¯å¢ƒæ£€æŸ¥</h4>
    
    <!-- æ•°å­—äººä¸è™šæ‹Ÿè®¾å¤‡é…å¯¹ä¿¡æ¯ -->
    <div class="persona-device-pairing" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
        <h5 style="margin: 0 0 8px 0; color: #495057;">ğŸ‘¤ æ•°å­—äººè®¾å¤‡é…å¯¹</h5>
        <div class="pairing-info" style="display: flex; align-items: center; gap: 10px;">
            <span class="persona-name" style="font-weight: bold;">æ•°å­—äºº_1</span>
            <span class="pairing-arrow" style="color: #6c757d;">â†â†’</span>
            <span class="virtual-device" style="color: #007bff;">è™šæ‹Ÿè®¾å¤‡ #001</span>
            <span class="pairing-status success" style="color: #28a745;">âœ… å·²é…å¯¹</span>
        </div>
    </div>
    
    <!-- AdsPoweræŒ‡çº¹æµè§ˆå™¨çŠ¶æ€ -->
    <div class="adspower-fingerprint-status" style="margin-bottom: 15px;">
        <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ”’ æŒ‡çº¹æµè§ˆå™¨çŠ¶æ€</h5>
        <div class="fingerprint-details" style="font-size: 12px;">
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">è®¾å¤‡ç±»å‹:</span>
                <span class="value" style="color: #6c757d;">MacBook Pro (Intel)</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">æ“ä½œç³»ç»Ÿ:</span>
                <span class="value" style="color: #6c757d;">macOS 10.15.7</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">æµè§ˆå™¨æŒ‡çº¹:</span>
                <span class="value" style="color: #6c757d;">Chrome 131.0.0.0</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">CanvasæŒ‡çº¹:</span>
                <span class="value" style="color: #6c757d;">å·²ä¼ªè£… (ç‹¬ç‰¹å€¼)</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">WebGLæŒ‡çº¹:</span>
                <span class="value" style="color: #6c757d;">å·²ä¼ªè£… (ç‹¬ç‰¹å€¼)</span>
                <span class="status-indicator success">âœ…</span>
            </div>
        </div>
    </div>
    
    <!-- é’æœä»£ç†IPçŠ¶æ€ -->
    <div class="proxy-ip-status" style="margin-bottom: 15px;">
        <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸŒ ä»£ç†IPçŠ¶æ€</h5>
        <div class="proxy-details" style="font-size: 12px;">
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">ä»£ç†ç±»å‹:</span>
                <span class="value" style="color: #6c757d;">é’æœä½å®…ä»£ç†</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">å½“å‰IP:</span>
                <span class="value" style="color: #6c757d;">123.456.789.012</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">IPå½’å±åœ°:</span>
                <span class="value" style="color: #6c757d;">åŒ—äº¬å¸‚æœé˜³åŒº</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">è¿æ¥å»¶è¿Ÿ:</span>
                <span class="value" style="color: #6c757d;">45ms</span>
                <span class="status-indicator success">âœ…</span>
            </div>
            <div class="detail-row" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="label">IPçº¯å‡€åº¦:</span>
                <span class="value" style="color: #6c757d;">é«˜ (æœªè¢«æ ‡è®°)</span>
                <span class="status-indicator success">âœ…</span>
            </div>
        </div>
    </div>
    
    <!-- åä½œå¼Šæ£€æµ‹çŠ¶æ€ -->
    <div class="anti-detection-status" style="margin-bottom: 15px;">
        <h5 style="margin: 0 0 10px 0; color: #495057;">ğŸ›¡ï¸ åä½œå¼ŠçŠ¶æ€</h5>
        <div class="detection-check" style="font-size: 12px;">
            <div class="check-item" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="check-name">è‡ªåŠ¨åŒ–æ£€æµ‹:</span>
                <span class="check-result safe" style="color: #28a745;">âœ… æœªæ£€æµ‹åˆ°</span>
            </div>
            <div class="check-item" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="check-name">è®¾å¤‡ä¸€è‡´æ€§:</span>
                <span class="check-result safe" style="color: #28a745;">âœ… å®Œå…¨ä¸€è‡´</span>
            </div>
            <div class="check-item" style="display: flex; justify-content: space-between; padding: 3px 0;">
                <span class="check-name">è¡Œä¸ºæ¨¡å¼:</span>
                <span class="check-result safe" style="color: #28a745;">âœ… çœŸäººè¡Œä¸º</span>
            </div>
        </div>
    </div>
    
    <!-- å®æ—¶éªŒè¯æŒ‰é’® -->
    <div class="verification-actions" style="text-align: center; margin-top: 15px;">
        <button class="btn-verify" onclick="verifyDeviceEnvironment()" 
                style="margin-right: 10px; padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">
            ğŸ” å®æ—¶éªŒè¯ç¯å¢ƒ
        </button>
        <button class="btn-test-ip" onclick="testProxyConnection()" 
                style="padding: 5px 15px; background: #28a745; color: white; border: none; border-radius: 3px; cursor: pointer;">
            ğŸŒ æµ‹è¯•ä»£ç†è¿æ¥
        </button>
    </div>
</div>

<script>
// è·å–è®¾å¤‡ç¯å¢ƒçŠ¶æ€
async function getDeviceEnvironmentStatus(persona_id) {
    try {
        showLoading('æ­£åœ¨è·å–è®¾å¤‡ç¯å¢ƒçŠ¶æ€...');
        const response = await fetch(`/api/device-environment/${persona_id}`);
        const data = await response.json();
        hideLoading();
        return data;
    } catch (error) {
        console.error('è·å–è®¾å¤‡ç¯å¢ƒçŠ¶æ€å¤±è´¥:', error);
        hideLoading();
        return null;
    }
}

// å®æ—¶éªŒè¯ç¯å¢ƒ
async function verifyDeviceEnvironment() {
    try {
        showLoading('æ­£åœ¨éªŒè¯è®¾å¤‡ç¯å¢ƒ...');
        const response = await fetch('/api/verify-environment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                persona_id: getCurrentPersonaId(),
                profile_id: getCurrentProfileId()
            })
        });
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            alert('âœ… è®¾å¤‡ç¯å¢ƒéªŒè¯é€šè¿‡ï¼\næ‰€æœ‰æŒ‡æ ‡æ­£å¸¸ã€‚');
        } else {
            alert('âš ï¸ è®¾å¤‡ç¯å¢ƒéªŒè¯å‘ç°é—®é¢˜ï¼š\n' + result.message);
        }
    } catch (error) {
        hideLoading();
        alert('âŒ ç¯å¢ƒéªŒè¯å¤±è´¥ï¼š' + error.message);
    }
}

// æµ‹è¯•ä»£ç†è¿æ¥
async function testProxyConnection() {
    try {
        showLoading('æ­£åœ¨æµ‹è¯•ä»£ç†è¿æ¥...');
        const response = await fetch('/api/test-proxy', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                persona_id: getCurrentPersonaId(),
                profile_id: getCurrentProfileId()
            })
        });
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            alert(`âœ… ä»£ç†è¿æ¥æµ‹è¯•æˆåŠŸï¼\nå½“å‰IP: ${result.ip}\nä½ç½®: ${result.location}\nå»¶è¿Ÿ: ${result.latency}`);
        } else {
            alert('âŒ ä»£ç†è¿æ¥æµ‹è¯•å¤±è´¥ï¼š\n' + result.message);
        }
    } catch (error) {
        hideLoading();
        alert('âŒ ä»£ç†æµ‹è¯•å¤±è´¥ï¼š' + error.message);
    }
}

// æ›´æ–°è®¾å¤‡ç¯å¢ƒæ˜¾ç¤º
async function updateDeviceEnvironmentDisplay(persona_id) {
    const environmentData = await getDeviceEnvironmentStatus(persona_id);
    if (!environmentData) return;
    
    // æ›´æ–°é…å¯¹ä¿¡æ¯
    const pairingInfo = environmentData.pairing_info || {};
    document.querySelector('.persona-name').textContent = pairingInfo.persona_name || `æ•°å­—äºº_${persona_id}`;
    document.querySelector('.virtual-device').textContent = pairingInfo.virtual_device || `è™šæ‹Ÿè®¾å¤‡_${persona_id}`;
    
    // æ›´æ–°æŒ‡çº¹æµè§ˆå™¨çŠ¶æ€
    const fingerprintStatus = environmentData.fingerprint_browser || {};
    updateDetailRows('.fingerprint-details', fingerprintStatus);
    
    // æ›´æ–°ä»£ç†IPçŠ¶æ€
    const proxyStatus = environmentData.proxy_ip || {};
    updateDetailRows('.proxy-details', proxyStatus);
    
    // æ›´æ–°åä½œå¼ŠçŠ¶æ€
    const antiDetectionStatus = environmentData.anti_detection || {};
    updateDetectionChecks(antiDetectionStatus);
}

// æ›´æ–°è¯¦æƒ…è¡Œ
function updateDetailRows(containerSelector, data) {
    const container = document.querySelector(containerSelector);
    if (!container || !data) return;
    
    const rows = container.querySelectorAll('.detail-row');
    rows.forEach(row => {
        const label = row.querySelector('.label').textContent;
        const valueElement = row.querySelector('.value');
        const statusElement = row.querySelector('.status-indicator');
        
        // æ ¹æ®æ ‡ç­¾æ›´æ–°å¯¹åº”çš„å€¼
        switch (label) {
            case 'è®¾å¤‡ç±»å‹:':
                if (data.device_type) valueElement.textContent = data.device_type;
                break;
            case 'å½“å‰IP:':
                if (data.current_ip) valueElement.textContent = data.current_ip;
                break;
            case 'IPå½’å±åœ°:':
                if (data.ip_location) valueElement.textContent = data.ip_location;
                break;
            // æ·»åŠ æ›´å¤šå­—æ®µæ˜ å°„...
        }
        
        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        if (data.overall_status === 'âœ… æ­£å¸¸') {
            statusElement.textContent = 'âœ…';
            statusElement.style.color = '#28a745';
        } else {
            statusElement.textContent = 'âŒ';
            statusElement.style.color = '#dc3545';
        }
    });
}

// è·å–å½“å‰æ•°å­—äººIDå’Œé…ç½®æ–‡ä»¶ID
function getCurrentPersonaId() {
    // ä»å½“å‰ç•Œé¢çŠ¶æ€è·å–
    return window.currentPersonaId || 1;
}

function getCurrentProfileId() {
    // ä»å½“å‰ç•Œé¢çŠ¶æ€è·å–
    return window.currentProfileId || 'profile_1';
}

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
function showLoading(message) {
    // å®ç°åŠ è½½çŠ¶æ€æ˜¾ç¤º
    console.log('Loading:', message);
}

// éšè—åŠ è½½çŠ¶æ€
function hideLoading() {
    // å®ç°åŠ è½½çŠ¶æ€éšè—
    console.log('Loading hidden');
}

// æ£€æŸ¥æ˜¯å¦æœ‰é˜¶æ®µè¯¦æƒ…
function hasPhaseDetails(task, phase) {
    if (phase.key === 'scout') {
        // æ•¢æ­»é˜Ÿé˜¶æ®µï¼šåªè¦å¼€å§‹å°±å¯ä»¥æŸ¥çœ‹ç¯å¢ƒè¯¦æƒ…
        const phaseStatus = getPhaseStatus(task, phase);
        return phaseStatus === 'in-progress' || phaseStatus === 'completed';
    }
    if (phase.key === 'guidance' && task.guidance_analysis) {
        return task.guidance_analysis.completed;
    }
    if (phase.key === 'target' && task.target_phase) {
        return task.target_phase.completed;
    }
    return false;
}

// æ˜¾ç¤ºé˜¶æ®µè¯¦æƒ…
function showPhaseDetails(taskId, phaseKey) {
    const task = activeTasks.get(taskId);
    if (!task) return;
    
    let content = '';
    
    if (phaseKey === 'scout') {
        // æ•¢æ­»é˜Ÿé˜¶æ®µï¼šæ˜¾ç¤ºç¯å¢ƒè¯¦æƒ… + æ‰§è¡Œç»“æœ
        content = generateScoutEnvironmentDetails(task);
    } else if (phaseKey === 'guidance' && task.guidance_analysis) {
        content = generateGuidancePhaseDetails(task.guidance_analysis);
    } else if (phaseKey === 'target' && task.target_phase) {
        content = generateTargetPhaseDetails(task.target_phase);
    } else {
        content = '<p>è¯¥é˜¶æ®µè¯¦æƒ…æš‚æœªå¯ç”¨</p>';
    }
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    document.getElementById('experienceContent').innerHTML = content;
    document.getElementById('experienceModal').style.display = 'block';
}

// ç”Ÿæˆæ•¢æ­»é˜Ÿç¯å¢ƒè¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
function generateScoutEnvironmentDetails(task) {
    const taskId = task.task_id;
    return `
        <h3>ğŸ§­ æ•¢æ­»é˜Ÿä¾¦å¯Ÿç¯å¢ƒè¯¦æƒ…</h3>
        
        <!-- ç¯å¢ƒä¿¡æ¯åŠ è½½åŒºåŸŸ -->
        <div id="environmentDetails_${taskId}" class="environment-details">
            <div class="loading-indicator">
                <span>ğŸ”„ æ­£åœ¨åŠ è½½ç¯å¢ƒè¯¦æƒ…...</span>
            </div>
        </div>
        
        <!-- å®æ—¶éªŒè¯æŒ‰é’® -->
        <div class="environment-actions" style="margin: 15px 0; text-align: center;">
            <button onclick="loadEnvironmentDetails('${taskId}')" 
                    style="margin-right: 10px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                ğŸ” åˆ·æ–°ç¯å¢ƒçŠ¶æ€
            </button>
            <button onclick="verifyEnvironmentSync('${taskId}')" 
                    style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                âœ… éªŒè¯ç¯å¢ƒåŒæ­¥
            </button>
        </div>
        
        <!-- æ‰§è¡Œç»“æœåŒºåŸŸ -->
        <div class="scout-execution-results">
            ${generateScoutExecutionResults(task)}
        </div>
    `;
}

// ç”Ÿæˆæ•¢æ­»é˜Ÿæ‰§è¡Œç»“æœ
function generateScoutExecutionResults(task) {
    if (!task.scout_phase || !task.scout_phase.completed) {
        return `
            <div class="execution-status">
                <h4>ğŸ“Š æ‰§è¡ŒçŠ¶æ€</h4>
                <p style="color: #6c757d;">æ•¢æ­»é˜Ÿæ­£åœ¨æ‰§è¡Œä¸­...</p>
            </div>
        `;
    }
    
    const scoutPhase = task.scout_phase;
    return `
        <div class="execution-results">
            <h4>ğŸ“Š æ‰§è¡Œç»“æœ</h4>
            <div class="phase-stats">
                <div class="stat-item">
                    <strong>æ‰§è¡Œæ•°é‡:</strong> ${scoutPhase.total_count}
                </div>
                <div class="stat-item">
                    <strong>æˆåŠŸæ•°é‡:</strong> ${scoutPhase.success_count}
                </div>
                <div class="stat-item">
                    <strong>æˆåŠŸç‡:</strong> ${scoutPhase.success_rate.toFixed(1)}%
                </div>
            </div>
            ${scoutPhase.results && scoutPhase.results.length > 0 ? `
                <h5>è¯¦ç»†ç»“æœ:</h5>
                <div class="results-list">
                    ${scoutPhase.results.map(result => `
                        <div class="result-item ${result.success ? 'success' : 'failed'}">
                            <strong>${result.scout_name || 'æ•¢æ­»é˜Ÿæˆå‘˜'}:</strong> 
                            ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
    `;
}

// åŠ è½½ç¯å¢ƒè¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
async function loadEnvironmentDetails(taskId) {
    const detailsContainer = document.getElementById(`environmentDetails_${taskId}`);
    if (!detailsContainer) return;
    
    try {
        detailsContainer.innerHTML = '<div class="loading-indicator"><span>ğŸ”„ æ­£åœ¨åŠ è½½ç¯å¢ƒè¯¦æƒ…...</span></div>';
        
        const response = await fetch(`/api/scout-environment-details/${taskId}`);
        const data = await response.json();
        
        if (data.success) {
            detailsContainer.innerHTML = renderEnvironmentDetails(data.environment_data);
        } else {
            detailsContainer.innerHTML = `<div class="error-message">âŒ åŠ è½½å¤±è´¥: ${data.message}</div>`;
        }
    } catch (error) {
        console.error('åŠ è½½ç¯å¢ƒè¯¦æƒ…å¤±è´¥:', error);
        detailsContainer.innerHTML = `<div class="error-message">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
    }
}

// æ¸²æŸ“ç¯å¢ƒè¯¦æƒ…ï¼ˆæ–°å¢ï¼‰
function renderEnvironmentDetails(envData) {
    if (!envData) return '<div class="error-message">âŒ æš‚æ— ç¯å¢ƒæ•°æ®</div>';
    
    return `
        <div class="environment-sections">
            <!-- æ•°å­—äººä¿¡æ¯ -->
            <div class="env-section">
                <h5>ğŸ¤– æ•°å­—äººè¯¦ç»†ä¿¡æ¯</h5>
                <div class="env-details">
                    ${renderPersonaDetails(envData.persona_info)}
                </div>
            </div>
            
            <!-- AdsPoweræµè§ˆå™¨é…ç½® -->
            <div class="env-section">
                <h5>ğŸ”’ AdsPoweræµè§ˆå™¨é…ç½®</h5>
                <div class="env-details">
                    ${renderBrowserDetails(envData.browser_config)}
                </div>
            </div>
            
            <!-- é’æœä»£ç†IPçŠ¶æ€ -->
            <div class="env-section">
                <h5>ğŸŒ é’æœä»£ç†IPçŠ¶æ€</h5>
                <div class="env-details">
                    ${renderProxyDetails(envData.proxy_status)}
                </div>
            </div>
            
            <!-- åä½œå¼ŠçŠ¶æ€ -->
            <div class="env-section">
                <h5>ğŸ›¡ï¸ åä½œå¼Šæ£€æµ‹çŠ¶æ€</h5>
                <div class="env-details">
                    ${renderAntiDetectionStatus(envData.anti_detection)}
                </div>
            </div>
        </div>
    `;
}

// æ¸²æŸ“æ•°å­—äººè¯¦æƒ… - æ”¯æŒå®Œæ•´å°ç¤¾ä¼šç³»ç»Ÿæ•°æ®
function renderPersonaDetails(personaInfo) {
    if (!personaInfo) return '<p>æš‚æ— æ•°å­—äººä¿¡æ¯</p>';
    
    const dataSourceBadge = getDataSourceBadge(personaInfo.data_source);
    const isCompleteData = personaInfo.data_source === 'xiaoshe_complete_api';
    
    let detailsHTML = `
        <div class="data-source-header">
            ${dataSourceBadge}
            ${isCompleteData ? `<span class="field-count">ğŸ“Š ${personaInfo.field_count || 0} ä¸ªå­—æ®µ</span>` : ''}
        </div>
        <div class="detail-grid">
            <div class="detail-row">
                <span class="label">æ•°å­—äººå§“å:</span>
                <span class="value">${personaInfo.name || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">å¹´é¾„:</span>
                <span class="value">${personaInfo.age || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">æ€§åˆ«:</span>
                <span class="value">${personaInfo.gender || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">èŒä¸š:</span>
                <span class="value">${personaInfo.occupation || 'æœªçŸ¥'}</span>
            </div>`;
    
    // å¦‚æœæ˜¯å®Œæ•´æ•°æ®ï¼Œæ˜¾ç¤ºæ›´å¤šå­—æ®µ
    if (isCompleteData) {
        detailsHTML += `
            <div class="detail-row">
                <span class="label">æ•™è‚²æ°´å¹³:</span>
                <span class="value">${personaInfo.education || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">æ”¶å…¥æ°´å¹³:</span>
                <span class="value">${personaInfo.income_level || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">å±…ä½åœ°:</span>
                <span class="value">${personaInfo.residence || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">å©šå§»çŠ¶å†µ:</span>
                <span class="value">${personaInfo.marital_status || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">å½“å‰å¿ƒæƒ…:</span>
                <span class="value">${personaInfo.current_mood || 'å¹³é™'}</span>
            </div>
            <div class="detail-row">
                <span class="label">å½“å‰æ´»åŠ¨:</span>
                <span class="value">${personaInfo.current_activity || 'æ—¥å¸¸'}</span>
            </div>`;
        
        // å“ç‰Œåå¥½
        if (personaInfo.favorite_brands && personaInfo.favorite_brands.length > 0) {
            detailsHTML += `
            <div class="detail-row full-width">
                <span class="label">å“ç‰Œåå¥½:</span>
                <span class="value">${personaInfo.favorite_brands.slice(0, 5).join('ã€')}</span>
            </div>`;
        }
        
        // ç­”é¢˜ç­–ç•¥éƒ¨åˆ†
        detailsHTML += `
            <div class="strategy-section">
                <div class="strategy-title">ğŸ“Š ç­”é¢˜ç­–ç•¥ç‰¹å¾</div>
                <div class="detail-row">
                    <span class="label">ç­”é¢˜é£æ ¼:</span>
                    <span class="value">${personaInfo.answer_style || 'æ ‡å‡†'}</span>
                </div>
                <div class="detail-row">
                    <span class="label">å›ç­”é€Ÿåº¦:</span>
                    <span class="value">${personaInfo.response_speed || 'æ­£å¸¸'}</span>
                </div>
                <div class="detail-row">
                    <span class="label">ç»†èŠ‚åå¥½:</span>
                    <span class="value">${personaInfo.detail_preference || 'é€‚ä¸­'}</span>
                </div>
                <div class="detail-row">
                    <span class="label">é£é™©æ‰¿å—:</span>
                    <span class="value">${personaInfo.risk_tolerance || 'ä¸­ç­‰'}</span>
                </div>
                <div class="detail-row">
                    <span class="label">è´¢åŠ¡æ•æ„Ÿåº¦:</span>
                    <span class="value">${personaInfo.financial_sensitivity || 'ä¸­ç­‰æ•æ„Ÿ'}</span>
                </div>
                <div class="detail-row">
                    <span class="label">ä¸ªäººæ•æ„Ÿåº¦:</span>
                    <span class="value">${personaInfo.personal_sensitivity || 'ä¸­ç­‰æ•æ„Ÿ'}</span>
                </div>
                <div class="detail-row">
                    <span class="label">å“ç‰Œæ•æ„Ÿåº¦:</span>
                    <span class="value">${personaInfo.brand_sensitivity || 'å“ç‰Œä¸­ç«‹'}</span>
                </div>
            </div>`;
    } else {
        // åŸºç¡€æ•°æ®æ˜¾ç¤º
        detailsHTML += `
            <div class="detail-row">
                <span class="label">æ€§æ ¼ç‰¹å¾:</span>
                <span class="value">${personaInfo.personality_traits || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">ç­”é¢˜é£æ ¼:</span>
                <span class="value">${personaInfo.answer_style || 'æœªçŸ¥'}</span>
            </div>`;
        
        if (personaInfo.error_reason) {
            detailsHTML += `
            <div class="detail-row error-info">
                <span class="label">é”™è¯¯ä¿¡æ¯:</span>
                <span class="value">${personaInfo.error_reason}</span>
            </div>`;
        }
    }
    
    detailsHTML += `
        </div>
    `;
    
    return detailsHTML;
}

// è·å–æ•°æ®æºæ ‡è¯†å¾½ç« 
function getDataSourceBadge(dataSource) {
    switch(dataSource) {
        case 'xiaoshe_complete_api':
            return '<span class="badge badge-success">âœ… å°ç¤¾ä¼šå®Œæ•´API</span>';
        case 'fallback':
            return '<span class="badge badge-warning">âš ï¸ å¤‡ç”¨æ•°æ®</span>';
        case 'default':
            return '<span class="badge badge-error">âŒ é»˜è®¤é…ç½®</span>';
        default:
            return '<span class="badge badge-info">â„¹ï¸ æœªçŸ¥æ¥æº</span>';
    }
}

// æ¸²æŸ“æµè§ˆå™¨è¯¦æƒ…
function renderBrowserDetails(browserConfig) {
    if (!browserConfig) return '<p>æš‚æ— æµè§ˆå™¨é…ç½®ä¿¡æ¯</p>';
    
    return `
        <div class="detail-grid">
            <div class="detail-row">
                <span class="label">é…ç½®æ–‡ä»¶ID:</span>
                <span class="value">${browserConfig.profile_id || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">è®¾å¤‡ç±»å‹:</span>
                <span class="value">${browserConfig.device_type || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">æ“ä½œç³»ç»Ÿ:</span>
                <span class="value">${browserConfig.operating_system || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">æµè§ˆå™¨ç‰ˆæœ¬:</span>
                <span class="value">${browserConfig.browser_version || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">CanvasæŒ‡çº¹:</span>
                <span class="value">${browserConfig.canvas_fingerprint || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">WebGLæŒ‡çº¹:</span>
                <span class="value">${browserConfig.webgl_fingerprint || 'æœªçŸ¥'}</span>
            </div>
        </div>
    `;
}

// æ¸²æŸ“ä»£ç†è¯¦æƒ…
function renderProxyDetails(proxyStatus) {
    if (!proxyStatus) return '<p>æš‚æ— ä»£ç†ä¿¡æ¯</p>';
    
    return `
        <div class="detail-grid">
            <div class="detail-row">
                <span class="label">ä»£ç†ç±»å‹:</span>
                <span class="value">${proxyStatus.proxy_type || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">å½“å‰IP:</span>
                <span class="value">${proxyStatus.current_ip || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">IPå½’å±åœ°:</span>
                <span class="value">${proxyStatus.ip_location || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">è¿æ¥å»¶è¿Ÿ:</span>
                <span class="value">${proxyStatus.latency || 'æœªçŸ¥'}</span>
            </div>
            <div class="detail-row">
                <span class="label">IPçº¯å‡€åº¦:</span>
                <span class="value">${proxyStatus.ip_purity || 'æœªçŸ¥'}</span>
            </div>
        </div>
    `;
}

// æ¸²æŸ“åä½œå¼ŠçŠ¶æ€
function renderAntiDetectionStatus(antiDetection) {
    if (!antiDetection) return '<p>æš‚æ— åä½œå¼Šä¿¡æ¯</p>';
    
    return `
        <div class="detail-grid">
            <div class="detail-row">
                <span class="label">è‡ªåŠ¨åŒ–æ£€æµ‹:</span>
                <span class="value ${antiDetection.automation_detected ? 'status-danger' : 'status-success'}">
                    ${antiDetection.automation_detected ? 'âŒ æ£€æµ‹åˆ°' : 'âœ… æœªæ£€æµ‹åˆ°'}
                </span>
            </div>
            <div class="detail-row">
                <span class="label">è®¾å¤‡ä¸€è‡´æ€§:</span>
                <span class="value ${antiDetection.device_consistency ? 'status-success' : 'status-danger'}">
                    ${antiDetection.device_consistency ? 'âœ… ä¸€è‡´' : 'âŒ ä¸ä¸€è‡´'}
                </span>
            </div>
            <div class="detail-row">
                <span class="label">è¡Œä¸ºæ¨¡å¼:</span>
                <span class="value ${antiDetection.behavior_natural ? 'status-success' : 'status-danger'}">
                    ${antiDetection.behavior_natural ? 'âœ… è‡ªç„¶' : 'âŒ å¼‚å¸¸'}
                </span>
            </div>
            <div class="detail-row">
                <span class="label">æ€»ä½“è¯„ä¼°:</span>
                <span class="value ${antiDetection.overall_status === 'safe' ? 'status-success' : 'status-danger'}">
                    ${antiDetection.overall_status === 'safe' ? 'âœ… å®‰å…¨' : 'âš ï¸ é£é™©'}
                </span>
            </div>
        </div>
    `;
}

// éªŒè¯ç¯å¢ƒåŒæ­¥ï¼ˆæ–°å¢ï¼‰
async function verifyEnvironmentSync(taskId) {
    try {
        const response = await fetch(`/api/verify-environment-sync/${taskId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            alert(`âœ… ç¯å¢ƒåŒæ­¥éªŒè¯é€šè¿‡ï¼\n${result.message}`);
            // è‡ªåŠ¨åˆ·æ–°ç¯å¢ƒè¯¦æƒ…
            loadEnvironmentDetails(taskId);
        } else {
            alert(`âš ï¸ ç¯å¢ƒåŒæ­¥éªŒè¯å¤±è´¥ï¼š\n${result.message}`);
        }
    } catch (error) {
        alert(`âŒ éªŒè¯è¯·æ±‚å¤±è´¥ï¼š${error.message}`);
    }
}
</script> 

<style>
:root {
    --primary-color: #2c3e50;
    --accent-color: #3498db;
    --success-color: #27ae60;
    --danger-color: #e74c3c;
    --warning-color: #f39c12;
    --background: #ecf0f1;
    --text-dark: #2c3e50;
    --text-light: #7f8c8d;
    --border-color: #bdc3c7;
    --shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* ç¯å¢ƒè¯¦æƒ…æ ·å¼ */
.environment-details {
    margin: 15px 0;
}

.environment-sections {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.env-section {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
}

.env-section h5 {
    margin: 0 0 10px 0;
    color: var(--text-dark);
    font-size: 14px;
    font-weight: 600;
}

.env-details {
    font-size: 12px;
}

.detail-grid {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    border-bottom: 1px solid #e9ecef;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-row .label {
    font-weight: 500;
    color: var(--text-dark);
    min-width: 100px;
}

.detail-row .value {
    color: var(--text-light);
    text-align: right;
    max-width: 200px;
    word-break: break-all;
}

.status-success {
    color: var(--success-color) !important;
}

.status-danger {
    color: var(--danger-color) !important;
}

.loading-indicator {
    text-align: center;
    padding: 20px;
    color: var(--text-light);
}

.error-message {
    background: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 4px;
    border: 1px solid #f5c6cb;
}

.environment-actions {
    border-top: 1px solid #e9ecef;
    padding-top: 15px;
}

.execution-status, .execution-results {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.execution-status h4, .execution-results h4 {
    margin: 0 0 10px 0;
    color: var(--text-dark);
    font-size: 14px;
}

.phase-stats {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.stat-item {
    background: white;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #e9ecef;
    font-size: 12px;
}

.results-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.result-item {
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
}

.result-item.success {
    background: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.result-item.failed {
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

/* æ–°å¢ï¼šæ•°æ®æºæ ‡è¯†æ ·å¼ */
.data-source-header {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.badge-warning {
    background-color: #fff3cd;
    color: #856404;
    border: 1px solid #ffeaa7;
}

.badge-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.badge-info {
    background-color: #cce7ff;
    color: #004085;
    border: 1px solid #bee5eb;
}

.field-count {
    font-size: 11px;
    color: var(--text-light);
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

/* ç­”é¢˜ç­–ç•¥éƒ¨åˆ†æ ·å¼ */
.strategy-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.strategy-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 8px;
}

.detail-row.full-width {
    flex-direction: column;
    align-items: flex-start;
}

.detail-row.full-width .label {
    margin-bottom: 4px;
}

.detail-row.error-info {
    background-color: #fff5f5;
    padding: 8px;
    border-radius: 4px;
    border-left: 3px solid var(--danger-color);
}

.detail-row.error-info .value {
    color: var(--danger-color);
    font-size: 11px;
}
</style> 